# TODO: APK 一键改名改 Host 重签名方案

## 目标

用户在 Linux 服务器部署后端后，无需安装 Flutter 环境，通过脚本即可：
1. 修改 APK 的应用名称（显示名）
2. 修改 APK 内的 API Host 地址（指向自己的服务器）
3. 重新签名 APK
4. 将 APK 托管在服务器上供用户下载

---

## 整体思路

```
开发机（有 Flutter）                    Linux 服务器（无 Flutter）
┌─────────────────────┐              ┌──────────────────────────────┐
│ flutter build apk   │  上传 APK    │ repack-apk.sh                │
│ → base.apk (模板)   │ ──────────→  │   1. apktool d base.apk      │
│                     │              │   2. 改 app_name / api_host   │
│                     │              │   3. apktool b → unsigned.apk │
│                     │              │   4. zipalign + apksigner     │
│                     │              │   → PoolAI-v1.0.0.apk        │
│                     │              │                              │
│                     │              │ Nginx 托管 /download/app.apk │
└─────────────────────┘              └──────────────────────────────┘
```

---

## 阶段一：Flutter App 适配（开发机）

### 1.1 创建配置文件机制

在 Flutter app 中创建 `assets/app_config.json`，运行时读取：

```json
{
  "api_host": "http://localhost:8000",
  "app_name": "Pool AI Knowledge"
}
```

**关键点**：API host 不能硬编码在 Dart 代码中（编译后无法修改），必须放在 assets 文件中，因为 assets 在 APK 中是明文存储的，可以被 apktool 解包后修改。

### 1.2 Flutter 端读取配置

```dart
// lib/config.dart
import 'dart:convert';
import 'package:flutter/services.dart';

class AppConfig {
  static late String apiHost;
  static late String appName;

  static Future<void> load() async {
    final raw = await rootBundle.loadString('assets/app_config.json');
    final json = jsonDecode(raw);
    apiHost = json['api_host'] ?? 'http://localhost:8000';
    appName = json['app_name'] ?? 'Pool AI Knowledge';
  }
}
```

### 1.3 构建模板 APK

```bash
cd app/
flutter build apk --release
# 输出: build/app/outputs/flutter-apk/app-release.apk
# 重命名为 base.apk 作为模板
```

### 1.4 所需改动文件清单

| 文件 | 改动 |
|------|------|
| `app/pubspec.yaml` | 添加 `assets/app_config.json` 到 assets |
| `app/assets/app_config.json` | 新建配置文件 |
| `app/lib/config.dart` | 新建配置加载类 |
| `app/lib/main.dart` | 启动时加载配置，使用 apiHost |
| `app/android/app/build.gradle.kts` | 配置 release 签名 |
| `app/android/app/src/main/AndroidManifest.xml` | 添加网络权限 |

---

## 阶段二：重打包脚本（Linux 服务器）

### 2.1 脚本功能：`repack-apk.sh`

```bash
sudo ./repack-apk.sh \
  --apk base.apk \
  --name "我的知识库" \
  --host "https://kb.example.com" \
  --output PoolAI.apk
```

### 2.2 脚本工作流程

```
1. 安装依赖（apktool, android SDK build-tools / apksigner）
2. apktool d base.apk -o work/         # 反编译
3. 修改 work/assets/app_config.json    # 改 api_host
4. 修改 work/res/values/strings.xml    # 改 app_name
5. 修改 work/AndroidManifest.xml       # 改 android:label
6. apktool b work/ -o unsigned.apk     # 重新打包
7. zipalign -v 4 unsigned.apk aligned.apk
8. apksigner sign --ks release.jks aligned.apk  # 签名
9. mv aligned.apk → 最终输出
```

### 2.3 签名密钥管理

脚本首次运行时自动生成签名密钥：

```bash
keytool -genkeypair \
  -keystore /opt/pool_ai_knowledge/apk/release.jks \
  -alias poolai \
  -keyalg RSA -keysize 2048 -validity 10000 \
  -storepass <auto-generated> \
  -dname "CN=Pool AI Knowledge, O=PoolAI, C=CN"
```

密钥保存在服务器上，密码写入 `.env` 或独立配置文件。

### 2.4 依赖安装

脚本需要自动安装的工具：

| 工具 | 用途 | 安装方式 |
|------|------|----------|
| `apktool` | APK 反编译/重打包 | 下载 jar + wrapper |
| `openjdk-17` | Java 运行时（apktool/keytool 需要） | apt/yum |
| `android SDK build-tools` | 提供 apksigner / zipalign | 下载或 apt |

---

## 阶段三：集成到部署流程

### 3.1 目录结构

```
/opt/pool_ai_knowledge/
├── backend/
├── frontend/
├── admin/
├── apk/                      # 新增
│   ├── base.apk              # 模板 APK（开发机构建后上传）
│   ├── release.jks           # 签名密钥（自动生成）
│   ├── repack-apk.sh         # 重打包脚本
│   └── output/
│       └── PoolAI-v1.0.0.apk # 重签名后的 APK
```

### 3.2 Nginx 配置添加下载路由

```nginx
# APK 下载
location /download/ {
    alias /opt/pool_ai_knowledge/apk/output/;
    add_header Content-Disposition "attachment";
    types {
        application/vnd.android.package-archive apk;
    }
}
```

用户访问 `https://kb.example.com/download/PoolAI-v1.0.0.apk` 即可下载。

### 3.3 deploy.sh 集成

在 `deploy.sh` 中添加可选步骤：

```bash
# 如果有 base.apk，自动重打包
if [[ -f "${APP_DIR}/apk/base.apk" ]]; then
    bash "${APP_DIR}/apk/repack-apk.sh" \
      --apk "${APP_DIR}/apk/base.apk" \
      --name "Pool AI Knowledge" \
      --host "http://${SERVER_IP}" \
      --output "${APP_DIR}/apk/output/PoolAI.apk"
fi
```

---

## 实施步骤（按优先级）

### P0 - 必须先完成
- [ ] 开发 Flutter app 核心功能（连接后端 API、知识库浏览、AI 对话）
- [ ] 实现 `assets/app_config.json` 配置机制
- [ ] 配置 Android release 签名，构建出可用的模板 APK

### P1 - 重打包脚本
- [ ] 编写 `repack-apk.sh` 脚本
  - [ ] 自动安装 apktool / openjdk / build-tools
  - [ ] 修改 app_config.json（api_host）
  - [ ] 修改 strings.xml + AndroidManifest.xml（app_name）
  - [ ] 自动生成签名密钥（首次）
  - [ ] zipalign + apksigner 重签名
- [ ] 将 base.apk 模板纳入项目或提供上传机制

### P2 - 部署集成
- [ ] deploy.sh 添加 APK 重打包步骤
- [ ] Nginx 添加 /download/ 路由
- [ ] 管理后台添加 APK 版本管理页面（可选）

---

## 注意事项

1. **assets 目录可被 apktool 直接修改** — 这是整个方案的基础，Dart 代码编译后不可改，但 assets 是原样打包的
2. **签名变更** — 重签名后的 APK 签名与原始不同，用户升级需要先卸载旧版。建议统一使用服务器生成的密钥
3. **apktool 版本兼容** — 需要 apktool 2.9+ 以支持最新 Android SDK 版本
4. **APK 大小** — Flutter release APK 通常 15-30MB，考虑使用 `--split-per-abi` 构建以减小体积
5. **网络权限** — AndroidManifest.xml 中必须声明 `android.permission.INTERNET`
6. **HTTP 明文** — 如果 api_host 是 http（非 https），需要在 AndroidManifest 中配置 `android:usesCleartextTraffic="true"`
